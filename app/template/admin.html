<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console - Grok2API</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slide-up{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
        .animate-slide-up{animation:slide-up .3s ease-out}
        .tab-btn{transition:all .2s ease}
        .hover-card{position:relative;display:inline-block}
        .hover-card-trigger{cursor:pointer}
        .hover-card-content{position:absolute;left:50%;transform:translateX(-50%);background:hsl(0 0% 3.9%);color:hsl(0 0% 98%);padding:8px 12px;border-radius:6px;font-size:12px;font-weight:500;white-space:nowrap;z-index:9999;pointer-events:none;opacity:0;visibility:hidden;transition:opacity .2s ease,transform .2s ease;box-shadow:0 4px 12px rgba(0,0,0,.25);border:1px solid hsl(0 0% 14.9%)}
        .hover-card:hover .hover-card-content{opacity:1;visibility:visible}
        .hover-card-content.top{bottom:100%;transform:translateX(-50%) translateY(-8px)}
        .hover-card-content.bottom{top:100%;transform:translateX(-50%) translateY(8px)}
        .hover-card-content::after{content:'';position:absolute;left:50%;transform:translateX(-50%);border:6px solid transparent;z-index:1000}
        .hover-card-content.top::after{top:100%;border-top-color:hsl(0 0% 3.9%)}
        .hover-card-content.bottom::after{bottom:100%;border-bottom-color:hsl(0 0% 3.9%)}
        .hover-card-trigger:hover+.hover-card-content{opacity:1;visibility:visible}
        [title]{position:relative}
        [title]:hover::after{content:attr(title);position:absolute;bottom:100%;left:50%;transform:translateX(-50%) translateY(-4px);background:hsl(0 0% 3.9%);color:hsl(0 0% 98%);padding:8px 12px;border-radius:4px;font-size:11px;white-space:pre-line;max-width:500px;min-width:300px;word-wrap:break-word;z-index:1000;pointer-events:none;box-shadow:0 2px 8px rgba(0,0,0,.15)}
        [title]:hover::before{content:'';position:absolute;bottom:100%;left:50%;transform:translateX(-50%);border:4px solid transparent;border-top-color:hsl(0 0% 3.9%);z-index:1000}
    </style>
    <script>
        tailwind.config={theme:{extend:{colors:{border:"hsl(0 0% 89%)",input:"hsl(0 0% 89%)",ring:"hsl(0 0% 3.9%)",background:"hsl(0 0% 100%)",foreground:"hsl(0 0% 3.9%)",primary:{DEFAULT:"hsl(0 0% 9%)",foreground:"hsl(0 0% 98%)"},secondary:{DEFAULT:"hsl(0 0% 96.1%)",foreground:"hsl(0 0% 9%)"},muted:{DEFAULT:"hsl(0 0% 96.1%)",foreground:"hsl(0 0% 45.1%)"},accent:{DEFAULT:"hsl(0 0% 96.1%)",foreground:"hsl(0 0% 9%)"},destructive:{DEFAULT:"hsl(0 84.2% 60.2%)",foreground:"hsl(0 0% 98%)"}}}}}
    </script>
</head>
<body class="h-full bg-background text-foreground antialiased">
    <!-- Navigation Bar -->
    <header class="sticky top-0 z-50 w-full border-b border-border/40 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
        <div class="mx-auto flex h-14 max-w-7xl items-center px-6">
            <div class="mr-4 flex items-baseline gap-3">
                <span class="font-bold text-xl">Grok2API</span>
                <span class="text-xs text-gray-400">by @Chenyme</span>
            </div>
            <div class="flex flex-1 items-center justify-end">
                <div class="flex items-center gap-2">
                    <div class="hover-card">
                        <span id="storageMode" class="hover-card-trigger inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-muted text-muted-foreground border">
                            <svg class="h-3 w-3 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <ellipse cx="12" cy="5" rx="9" ry="3"/>
                                <path d="m21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                                <path d="m3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                            </svg>
                            <span id="storageModeText">FILE</span>
                        </span>
                        <div id="storageModeTooltip" class="hover-card-content top">
                            Loading...
                        </div>
                    </div>
                    <nav class="flex items-center gap-1">
                    <a
                        href="https://github.com/chenyme/grok2api/issues"
                        target="_blank"
                        class="inline-flex items-center justify-center text-xs transition-colors hover:bg-accent hover:text-accent-foreground h-7 px-2.5 gap-1"
                    >
                        <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        Feedback
                    </a>
                    <button
                        onclick="logout()"
                        class="inline-flex items-center justify-center text-xs transition-colors hover:bg-accent hover:text-accent-foreground h-7 px-2.5 gap-1"
                    >
                        <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16 17 21 12 16 7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                        Logout
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <main class="mx-auto max-w-7xl px-6 py-6">
        <!-- Tab Navigation -->
        <div class="border-b border-border mb-6">
            <nav class="flex space-x-8">
                <button onclick="switchTab('tokens')" id="tabTokens" class="tab-btn border-b-2 border-primary text-sm font-medium py-3 px-1">Token Management</button>
                <button onclick="switchTab('settings')" id="tabSettings" class="tab-btn border-b-2 border-transparent text-sm font-medium py-3 px-1">Settings</button>
                <button onclick="switchTab('cloudinary')" id="tabCloudinary" class="tab-btn border-b-2 border-transparent text-sm font-medium py-3 px-1">Cloudinary</button>
            </nav>
        </div>

        <!-- Token Management Panel -->
        <div id="panelTokens">
        <!-- Statistics Cards -->
        <div class="grid gap-4 grid-cols-2 md:grid-cols-4 mb-6">
            <div class="rounded-lg border border-border bg-background p-4">
                <p class="text-sm font-medium text-muted-foreground mb-2">Total Tokens</p>
                <h3 class="text-xl font-bold" id="statTotal">-</h3>
            </div>

            <div class="rounded-lg border border-border bg-background p-4">
                <p class="text-sm font-medium text-muted-foreground mb-2">Unused</p>
                <h3 class="text-xl font-bold text-gray-500" id="statUnused">-</h3>
            </div>

            <div class="rounded-lg border border-border bg-background p-4">
                <p class="text-sm font-medium text-muted-foreground mb-2">Rate-Limited</p>
                <h3 class="text-xl font-bold text-orange-600" id="statLimited">-</h3>
            </div>

            <div class="rounded-lg border border-border bg-background p-4">
                <p class="text-sm font-medium text-muted-foreground mb-2">Expired</p>
                <h3 class="text-xl font-bold text-destructive" id="statExpired">-</h3>
            </div>

            <div class="rounded-lg border border-border bg-background p-4">
                <p class="text-sm font-medium text-muted-foreground mb-2">Active</p>
                <h3 class="text-xl font-bold text-green-600" id="statActive">-</h3>
            </div>

            <div class="rounded-lg border border-border bg-background p-4">
                <p class="text-sm font-medium text-muted-foreground mb-2">Total Remaining</p>
                <h3 class="text-xl font-bold" id="statTotalRemaining">-</h3>
            </div>

            <div class="rounded-lg border border-border bg-background p-4">
                <p class="text-sm font-medium text-muted-foreground mb-2">Normal Remaining</p>
                <h3 class="text-xl font-bold text-blue-600" id="statNormalRemaining">-</h3>
            </div>

            <div class="rounded-lg border border-border bg-background p-4">
                <p class="text-sm font-medium text-muted-foreground mb-2">Heavy Remaining</p>
                <h3 class="text-xl font-bold text-purple-600" id="statHeavyRemaining">-</h3>
            </div>
        </div>

        <!-- Token List -->
        <div class="rounded-lg border border-border bg-background">
            <!-- Toolbar -->
            <div class="flex items-center justify-between gap-4 p-4 border-b border-border">
                <div class="flex items-center gap-3 flex-1">
                    <div class="flex items-center gap-2">
                        <select id="filterType" onchange="filterTokens()" class="h-8 px-3 text-sm rounded-md border border-input bg-background focus:outline-none focus:ring-1 focus:ring-ring">
                            <option value="all">All Types</option>
                            <option value="sso">SSO</option>
                            <option value="ssoSuper">SuperSSO</option>
                        </select>
                        <select id="filterStatus" onchange="filterTokens()" class="h-8 px-3 text-sm rounded-md border border-input bg-background focus:outline-none focus:ring-1 focus:ring-ring">
                            <option value="all">All Statuses</option>
                            <option value="Unused">Unused</option>
                            <option value="Rate-Limited">Rate-Limited</option>
                            <option value="Expired">Expired</option>
                            <option value="Active">Active</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <button 
                        onclick="refreshTokens()"
                        class="inline-flex items-center justify-center rounded-md transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring hover:bg-accent hover:text-accent-foreground h-8 w-8"
                        title="Refresh List"
                    >
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"/>
                            <polyline points="1 20 1 14 7 14"/>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                    </button>
                    <button
                        onclick="refreshAllLimits()"
                        class="inline-flex items-center justify-center rounded-md transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring hover:bg-blue-100 hover:text-blue-800 h-8 w-8"
                        title="Refresh All Rate Limits"
                    >
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 2v6h6"/>
                            <path d="M21 12A9 9 0 0 0 6 5.3L3 8"/>
                            <path d="M21 22v-6h-6"/>
                            <path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/>
                        </svg>
                    </button>
                    <span id="refresh-status" class="text-xs text-muted-foreground ml-2"></span>
                    <div id="batchActions" class="hidden items-center gap-2">
                        <button
                            onclick="exportSelected()"
                            class="inline-flex items-center justify-center rounded-md transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring hover:bg-accent hover:text-accent-foreground h-8 w-8"
                            title="Export Selected"
                        >
                            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                        </button>
                        <button
                            onclick="batchDelete()"
                            class="inline-flex items-center justify-center rounded-md transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring hover:bg-destructive/10 hover:text-destructive h-8 w-8"
                            title="Batch Delete"
                        >
                            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                <line x1="10" y1="11" x2="10" y2="17"/>
                                <line x1="14" y1="11" x2="14" y2="17"/>
                            </svg>
                        </button>
                    </div>
                    <button
                        onclick="openAddModal()"
                        class="inline-flex items-center justify-center rounded-md transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring bg-primary text-primary-foreground hover:bg-primary/90 h-8 px-3"
                        title="Add Token"
                    >
                        <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        <span class="text-sm font-medium">Add</span>
                    </button>
                </div>
            </div>
            
            <!-- Table -->
            <div class="relative w-full overflow-auto">
                <table class="w-full text-sm table-fixed">
                    <thead>
                        <tr class="border-b border-border">
                            <th class="h-10 px-3 text-left align-middle font-medium w-12">
                                <input
                                    type="checkbox"
                                    id="selectAll"
                                    onchange="toggleSelectAll()"
                                    class="h-3.5 w-3.5 rounded border border-input focus:ring-1 focus:ring-ring"
                                >
                            </th>
                            <th class="h-10 px-3 text-left align-middle text-sm font-medium text-muted-foreground w-72">Token</th>
                            <th class="h-10 px-3 text-left align-middle text-sm font-medium text-muted-foreground w-20">Type</th>
                            <th class="h-10 px-3 text-left align-middle text-sm font-medium text-muted-foreground w-20">Status</th>
                            <th class="h-10 px-3 text-left align-middle text-sm font-medium text-muted-foreground w-20">Normal Remaining</th>
                            <th class="h-10 px-3 text-left align-middle text-sm font-medium text-muted-foreground w-20">Heavy Remaining</th>
                            <th class="h-10 px-3 text-left align-middle text-sm font-medium text-muted-foreground w-40">Created Time</th>
                            <th class="h-10 px-3 text-right align-middle text-sm font-medium text-muted-foreground w-20">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tokenTableBody" class="divide-y divide-border">
                        <!-- Dynamic Content -->
                    </tbody>
                </table>
            </div>
            
            <div id="emptyState" class="hidden flex flex-col items-center justify-center py-12">
                <svg class="h-10 w-10 text-muted-foreground/50 mb-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <path d="M9 9h6v6H9z"/>
                </svg>
                <p class="text-sm text-muted-foreground">No data</p>
            </div>
        </div>
        </div>

        <!-- Global Settings Panel -->
        <div id="panelSettings" class="hidden">
            <!-- Global Configuration Area -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold">Global Settings</h2>
                    <button onclick="saveGlobalSettings()" class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-secondary text-secondary-foreground hover:bg-black hover:text-white h-9 px-4 transition-colors">Save Settings</button>
                </div>
                <div class="grid gap-4 lg:grid-cols-3">
                    <!-- System Settings -->
                    <div class="rounded-lg border border-border bg-background p-6">
                        <h3 class="text-sm font-semibold mb-4">System Settings</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-1">
                                    Admin Username
                                    <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground text-muted-foreground cursor-help" style="font-size:10px;line-height:1" title="Username for admin console">?</span>
                                </label>
                                <input id="cfgAdminUser" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="admin">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-1">
                                    Admin Password
                                    <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground text-muted-foreground cursor-help" style="font-size:10px;line-height:1" title="Password for admin console. Leave blank to keep current password.">?</span>
                                </label>
                                <input id="cfgAdminPass" type="password" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="Leave blank to keep current">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-1">
                                    Log Level
                                    <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground text-muted-foreground cursor-help" style="font-size:10px;line-height:1" title="Log verbosity. DEBUG: most detailed | INFO: general info | WARNING: warnings | ERROR: only errors">?</span>
                                </label>
                                <select id="cfgLogLevel" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                                    <option>DEBUG</option><option>INFO</option><option>WARNING</option><option>ERROR</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Media Settings -->
                    <div class="rounded-lg border border-border bg-background p-6">
                        <h3 class="text-sm font-semibold mb-4">Media Settings</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-1">
                                    Image Mode
                                    <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground text-muted-foreground cursor-help" style="font-size:10px;line-height:1" title="How images are returned. URL: image link, supports caching | Base64: base64 encoded, no caching">?</span>
                                </label>
                                <select id="cfgImageMode" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                                    <option value="url">URL (Image Link)</option>
                                    <option value="base64">Base64 (base64 encoded)</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-1">
                                    Service URL
                                    <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground text-muted-foreground cursor-help" style="font-size:10px;line-height:1" title="Public URL of the server, used to build image URLs (only needed for URL image mode)">?</span>
                                </label>
                                <input id="cfgBaseUrl" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="http://localhost:8000">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-1">
                                        Image Cache (MB)
                                        <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground text-muted-foreground cursor-help" style="font-size:10px;line-height:1" title="Max image cache size (MB). Old cache will be cleared when exceeded.">?</span>
                                    </label>
                                    <input id="cfgImageCacheMaxSize" type="number" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="500">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-1">
                                        Video Cache (MB)
                                        <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground text-muted-foreground cursor-help" style="font-size:10px;line-height:1" title="Max video cache size (MB). Old cache will be cleared when exceeded.">?</span>
                                    </label>
                                    <input id="cfgVideoCacheMaxSize" type="number" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="1000">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cache Management -->
                    <div class="rounded-lg border border-border bg-background p-6">
                        <h3 class="text-sm font-semibold mb-4">Cache Management</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm font-medium text-muted-foreground mb-2 block">Image Cache</label>
                                <div class="flex gap-2">
                                    <input id="imageCacheSize" readonly class="flex h-9 flex-1 rounded-md border border-input bg-muted px-3 py-2 text-sm" placeholder="0 MB">
                                    <button onclick="clearImageCache()" class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-secondary text-secondary-foreground hover:bg-red-600 hover:text-white h-9 w-9 p-0 transition-colors">
                                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-muted-foreground mb-2 block">Video Cache</label>
                                <div class="flex gap-2">
                                    <input id="videoCacheSize" readonly class="flex h-9 flex-1 rounded-md border border-input bg-muted px-3 py-2 text-sm" placeholder="0 MB">
                                    <button onclick="clearVideoCache()" class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-secondary text-secondary-foreground hover:bg-red-600 hover:text-white h-9 w-9 p-0 transition-colors">
                                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-muted-foreground mb-2 block">All Cache</label>
                                <div class="flex gap-2">
                                    <input id="totalCacheSize" readonly class="flex h-9 flex-1 rounded-md border border-input bg-muted px-3 py-2 text-sm font-medium" placeholder="0 MB">
                                    <button onclick="clearCache()" class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-secondary text-secondary-foreground hover:bg-red-600 hover:text-white h-9 w-9 p-0 transition-colors">
                                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grok Configuration Area -->
            <div>
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold">Grok Settings</h2>
                    <button onclick="saveGrokSettings()" class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-secondary text-secondary-foreground hover:bg-black hover:text-white h-9 px-4 transition-colors">Save Settings</button>
                </div>
                <div class="grid gap-4 lg:grid-cols-3">
                    <!-- Basic Settings -->
                    <div class="rounded-lg border border-border bg-background p-6">
                        <h3 class="text-sm font-semibold mb-4">Basic Settings</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-1">
                                    API Key
                                    <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground text-muted-foreground cursor-help" style="font-size:10px;line-height:1" title="API key for authentication, used to protect API access">?</span>
                                </label>
                                <input id="cfgApiKey" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-1">
                                    X Statsig ID
                                    <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground text-muted-foreground cursor-help" style="font-size:10px;line-height:1" title="Statsig ID for experiments and analytics">?</span>
                                </label>
                                <input id="cfgStatsigId" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-1">
                                    Filter Tags
                                    <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground text-muted-foreground cursor-help" style="font-size:10px;line-height:1" title="Tags to filter from response, comma-separated. e.g.: xaiartifact,xai:tool_usage_card">?</span>
                                </label>
                                <input id="cfgFilteredTags" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="xaiartifact,xai:tool_usage_card">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-1">
                                    Temporary Session
                                    <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground text-muted-foreground cursor-help" style="font-size:10px;line-height:1" title="If enabled, each conversation creates a new session without history. If disabled, conversations can be continued.">?</span>
                                </label>
                                <select id="cfgTemporary" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                                    <option value="false">Off</option>
                                    <option value="true">On</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Proxy Settings -->
                    <div class="rounded-lg border border-border bg-background p-6">
                        <h3 class="text-sm font-semibold mb-4">Proxy Settings</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-1">
                                    CF Clearance
                                    <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground text-muted-foreground cursor-help" style="font-size:10px;line-height:1" title="Cloudflare verification cookie, used to bypass Cloudflare's bot check.">?</span>
                                </label>
                                <input id="cfgCfClearance" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-1">
                                    Proxy Url (Service Proxy)
                                    <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground text-muted-foreground cursor-help" style="font-size:10px;line-height:1" title="Proxy for API requests and uploads. Supports http, https, socks5. Format: socks5://user:pass@host:port">?</span>
                                </label>
                                <input id="cfgProxyUrl" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="socks5://username:password@127.0.0.1:7890">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-1">
                                    Cache Proxy Url (Cache Proxy)
                                    <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground text-muted-foreground cursor-help" style="font-size:10px;line-height:1" title="Dedicated proxy for image/video cache downloads. If not set, service proxy is used. Grok's media endpoints have low IP risk control, so cheaper high-bandwidth nodes can be used.">?</span>
                                </label>
                                <input id="cfgCacheProxyUrl" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="socks5://username:password@127.0.0.1:7890">
                            </div>
                        </div>
                    </div>

                    <!-- Timeout Settings -->
                    <div class="rounded-lg border border-border bg-background p-6">
                        <h3 class="text-sm font-semibold mb-4">Timeout Settings</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-1">
                                    First Response Timeout (s)
                                    <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground text-muted-foreground cursor-help" style="font-size:10px;line-height:1" title="Max time to wait for the first data chunk from the API (seconds). Will error on timeout. Recommended: 30-60s">?</span>
                                </label>
                                <input id="cfgStreamFirstResponseTimeout" type="number" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="30">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-1">
                                    Stream Interval Timeout (s)
                                    <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground text-muted-foreground cursor-help" style="font-size:10px;line-height:1" title="Max interval between data chunks (seconds). Connection will be closed if exceeded. Recommended: 60-180s">?</span>
                                </label>
                                <input id="cfgStreamChunkTimeout" type="number" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="120">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-muted-foreground mb-2 flex items-center gap-1">
                                    Total Generation Timeout (s)
                                    <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-muted-foreground text-muted-foreground cursor-help" style="font-size:10px;line-height:1" title="Max total time for the entire conversation generation (seconds). For very long conversations. Recommended: 300-900s">?</span>
                                </label>
                                <input id="cfgStreamTotalTimeout" type="number" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="600">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration Notes -->
            <div class="mt-8 rounded border border-blue-300 bg-blue-50 px-4 py-3">
                <div class="text-xs text-gray-800 leading-relaxed">
                    <div class="text-base font-medium text-gray-900 mb-2.5">Notes</div>
                    <div class="space-y-1.5">
                        <div><span class="font-medium">X Statsig ID:</span> Anti-bot verification parameter. Do not modify unless necessary.</div>
                        <div><span class="font-medium">Service URL:</span> Your public service URL (e.g., https://yourdomain.com) is needed to construct image/video URLs. Can be left blank if you don't use video and use Base64 mode for images.</div>
                        <div><span class="font-medium">Proxy Settings:</span> The service proxy is for Grok API access and image uploads. The cache proxy is specifically for downloading image/video cache. If only the service proxy is set, it will be used for caching too. If both are set, they are used separately.</div>
                        <div><span class="font-medium">Request 403:</span> Usually blocked by Cloudflare. Solutions: 1. Change server IP | 2. Configure a proxy IP | 3. Visit grok.com on the server, pass the CF check, then get cf_clearance from F12 developer tools.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cloudinary Configuration Panel -->
        <div id="panelCloudinary" class="hidden">
            <div class="rounded-lg border border-border bg-background">
                <div class="flex items-center justify-between gap-4 p-4 border-b border-border">
                    <h2 class="text-xl font-bold">Cloudinary Account Management</h2>
                    <button
                        onclick="openAddCloudinaryModal()"
                        class="inline-flex items-center justify-center rounded-md transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring bg-primary text-primary-foreground hover:bg-primary/90 h-8 px-3"
                    >
                        <svg class="h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        <span class="text-sm font-medium">Add</span>
                    </button>
                </div>
                <div class="relative w-full overflow-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-border">
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">Cloud Name</th>
                                <th class="h-10 px-3 text-left align-middle font-medium text-muted-foreground">API Key</th>
                                <th class="h-10 px-3 text-right align-middle font-medium text-muted-foreground">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="cloudinaryTableBody" class="divide-y divide-border">
                            <!-- Dynamic Content -->
                        </tbody>
                    </table>
                </div>
                <div id="cloudinaryEmptyState" class="hidden flex flex-col items-center justify-center py-12">
                    <svg class="h-10 w-10 text-muted-foreground/50 mb-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <path d="M9 9h6v6H9z"/>
                    </svg>
                    <p class="text-sm text-muted-foreground">No data</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Cloudinary Account Modal -->
    <div id="addCloudinaryModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div class="bg-background rounded-lg border border-border w-full max-w-lg max-h-[90vh] overflow-y-auto shadow-xl">
            <div class="flex items-center justify-between p-5 border-b border-border">
                <h3 class="text-lg font-semibold">Add Cloudinary Account</h3>
                <button onclick="closeAddCloudinaryModal()" class="text-muted-foreground hover:text-foreground transition-colors">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            
            <div class="flex items-center px-5 pt-4 border-b border-border/50">
                <nav class="flex space-x-6" aria-label="Tabs">
                    <button onclick="switchModalTab('cloudinary', 'bulk')" id="tabCloudinaryBulk" class="border-b-2 border-primary text-primary py-2 text-sm font-medium transition-colors">Bulk Import</button>
                    <button onclick="switchModalTab('cloudinary', 'single')" id="tabCloudinarySingle" class="border-b-2 border-transparent text-muted-foreground hover:text-foreground py-2 text-sm font-medium transition-colors">Single Entry</button>
                </nav>
            </div>

            <div class="p-5">
                <!-- Bulk Mode -->
                <div id="panelCloudinaryBulk" class="space-y-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-muted-foreground">Account List <span class="text-xs text-muted-foreground/70 ml-1">(one URL per line)</span></label>
                        <textarea
                            id="addCloudinaryAccountList"
                            rows="8"
                            placeholder="cloudinary://api_key:api_secret@cloud_name"
                            class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-ring font-mono resize-none"
                        ></textarea>
                        <p class="text-[11px] text-muted-foreground">Format: cloudinary://&lt;api_key&gt;:&lt;api_secret&gt;@&lt;cloud_name&gt;</p>
                    </div>
                </div>

                <!-- Single Mode -->
                <div id="panelCloudinarySingle" class="hidden space-y-4">
                    <div class="space-y-3">
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-foreground">Cloud Name</label>
                            <input id="addCloudinaryName" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-ring" placeholder="e.g. my-cloud-name">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-foreground">API Key</label>
                            <input id="addCloudinaryKey" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-ring" placeholder="e.g. 123456789012345">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-foreground">API Secret</label>
                            <input id="addCloudinarySecret" type="password" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-ring" placeholder="e.g. abcde_FGHIJ_klmno12345">
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-end gap-3 p-5 border-t border-border bg-muted/30">
                <button
                    onclick="closeAddCloudinaryModal()"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent h-9 px-5"
                >
                    Cancel
                </button>
                <button
                    onclick="submitAddCloudinaryAccount()"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5"
                >
                    Add
                </button>
            </div>
        </div>
    </div>

    <!-- Add Token Modal -->
    <div id="addModal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div class="bg-background rounded-lg border border-border w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-xl">
            <div class="flex items-center justify-between p-5 border-b border-border">
                <h3 class="text-lg font-semibold">Add Token</h3>
                <button onclick="closeAddModal()" class="text-muted-foreground hover:text-foreground transition-colors">
                    <svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            
            <div class="px-5 pt-5 pb-2">
                <label class="text-xs font-medium text-muted-foreground uppercase tracking-wider mb-2 block">Token Configuration</label>
                <div class="space-y-2 mb-4">
                    <label class="text-sm font-medium text-foreground">Token Type</label>
                    <select id="addTokenType" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-ring">
                        <option value="sso">SSO</option>
                        <option value="ssoSuper">SuperSSO</option>
                    </select>
                </div>
            </div>

            <div class="flex items-center px-5 border-b border-border/50">
                <nav class="flex space-x-6" aria-label="Tabs">
                    <button onclick="switchModalTab('token', 'bulk')" id="tabTokenBulk" class="border-b-2 border-primary text-primary py-2 text-sm font-medium transition-colors">Bulk Import</button>
                    <button onclick="switchModalTab('token', 'single')" id="tabTokenSingle" class="border-b-2 border-transparent text-muted-foreground hover:text-foreground py-2 text-sm font-medium transition-colors">Single Entry</button>
                </nav>
            </div>

            <div class="p-5">
                <!-- Bulk Mode -->
                <div id="panelTokenBulk" class="space-y-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-muted-foreground">Token List <span class="text-xs text-muted-foreground/70 ml-1">(one per line)</span></label>
                        <textarea
                            id="addTokenList"
                            rows="8"
                            placeholder="Enter tokens, one per line"
                            class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-ring font-mono resize-none"
                        ></textarea>
                    </div>
                </div>

                <!-- Single Mode -->
                <div id="panelTokenSingle" class="hidden space-y-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-foreground">Token Value</label>
                        <input 
                            id="addTokenSingleInput" 
                            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-ring font-mono" 
                            placeholder="Paste token here"
                        >
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-end gap-3 p-5 border-t border-border bg-muted/30">
                <button
                    onclick="closeAddModal()"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent h-9 px-5"
                >
                    Cancel
                </button>
                <button
                    onclick="submitAddTokens()"
                    class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-5"
                >
                    Add
                </button>
            </div>
        </div>
    </div>

    <script>
        let allTokens=[],filteredTokens=[],selectedTokens=new Set();
        const $=(id)=>document.getElementById(id),
        checkAuth=()=>{const t=localStorage.getItem('adminToken');return t||(location.href='/login',null),t},
        apiRequest=async(url,opts={})=>{const t=checkAuth();if(!t)return null;const r=await fetch(url,{...opts,headers:{...opts.headers,Authorization:`Bearer ${t}`,'Content-Type':'application/json'}});return r.status===401?(localStorage.removeItem('adminToken'),location.href='/login',null):r},
        loadStats=async()=>{try{const r=await apiRequest('/api/stats');if(!r)return;const d=await r.json();if(d.success){const s=d.data;$('statTotal').textContent=s.total||0;['Unused','Limited','Expired','Active'].forEach((k,i)=>$(`stat${k}`).textContent=(s.normal?.[k.toLowerCase()]||0)+(s.super?.[k.toLowerCase()]||0))}}catch(e){console.error('Failed to load stats:',e)}},
        calcRemaining=()=>{let n=0,h=0;allTokens.forEach(t=>{if(t.remaining_queries>0)n+=t.remaining_queries;if(t.heavy_remaining_queries>0)h+=t.heavy_remaining_queries});return{normal:n,heavy:h,total:n+h}},
        loadTokens=async()=>{try{const r=await apiRequest('/api/tokens');if(!r)return;const d=await r.json();d.success&&(allTokens=d.data,filteredTokens=allTokens,selectedTokens.clear(),renderTokens(),updateRemaining())}catch(e){console.error('Failed to load list:',e)}},
        updateRemaining=()=>{const r=calcRemaining();['Total','Normal','Heavy'].forEach(k=>$(`stat${k}Remaining`).textContent=r[k.toLowerCase()]===0?'-':r[k.toLowerCase()].toLocaleString())}

        const renderTokens=()=>{const tb=$('tokenTableBody'),es=$('emptyState'),ss={'Unused':'bg-muted text-muted-foreground','Rate-Limited':'bg-orange-50 text-orange-700 border-orange-200','Expired':'bg-destructive/10 text-destructive border-destructive/20','Active':'bg-green-50 text-green-700 border-green-200'},ts={sso:'bg-blue-50 text-blue-700 border-blue-200',ssoSuper:'bg-purple-50 text-purple-700 border-purple-200'},tl={sso:'SSO',ssoSuper:'SuperSSO'};if(!filteredTokens.length){tb.innerHTML='';es.classList.remove('hidden');$('selectAll').checked=false;return updateBatchActions()}es.classList.add('hidden');tb.innerHTML=filteredTokens.map(t=>`<tr class="transition-colors"><td class="py-2.5 px-3 align-middle w-12"><input type="checkbox" class="token-checkbox h-3.5 w-3.5 rounded border border-input focus:ring-1 focus:ring-ring" data-token="${t.token}" data-type="${t.token_type}" ${selectedTokens.has(t.token)?'checked':''} onchange="toggleToken('${t.token}')"></td><td class="py-2.5 px-3 align-middle w-80"><div class="flex items-center gap-2"><span class="font-mono text-xs">${t.token.substring(0,30)}...</span><button onclick="copyToken('${t.token.replace(/'/g,"\\'")}',event)" class="inline-flex items-center justify-center rounded-md transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring hover:bg-accent h-6 w-6" title="Copy Full Token"><svg class="h-3 w-3 text-muted-foreground" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button></div></td><td class="py-2.5 px-3 align-middle w-20"><span class="inline-flex items-center rounded-full px-1.5 py-0.5 text-xs font-medium border ${ts[t.token_type]}">${tl[t.token_type]}</span></td><td class="py-2.5 px-3 align-middle w-20"><span class="inline-flex items-center rounded-full px-1.5 py-0.5 text-xs font-medium border ${ss[t.status]}">${t.status}</span></td><td class="py-2.5 px-3 align-middle w-20 text-xs tabular-nums">${t.remaining_queries===-1?'-':t.remaining_queries}</td><td class="py-2.5 px-3 align-middle w-20 text-xs tabular-nums">${t.heavy_remaining_queries===-1?'-':t.heavy_remaining_queries}</td><td class="py-2.5 px-3 align-middle w-32 text-xs text-muted-foreground">${t.created_time?new Date(t.created_time).toLocaleString('en-US',{dateStyle:'short',timeStyle:'short'}):'-'}</td><td class="py-2.5 px-3 align-middle text-right w-16"><button onclick="deleteToken('${t.token}','${t.token_type}')" class="inline-flex items-center justify-center rounded-md text-xs font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring hover:bg-destructive/10 hover:text-destructive h-7 w-7"><svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button></td></tr>`).join('');updateBatchActions()},
        toggleToken=t=>selectedTokens[selectedTokens.has(t)?'delete':'add'](t)||updateBatchActions(),
        toggleSelectAll=()=>{const sa=$('selectAll');sa.checked?filteredTokens.forEach(t=>selectedTokens.add(t.token)):selectedTokens.clear();renderTokens()},
        updateBatchActions=()=>{const ba=$('batchActions'),sc=$('selectedCount'),c=selectedTokens.size;ba.classList[c>0?'add':'remove']('flex');ba.classList[c>0?'remove':'add']('hidden');c>0&&(sc.textContent=`${c} selected`);$('selectAll').checked=filteredTokens.length>0&&c===filteredTokens.length},
        filterTokens=()=>{const tf=$('filterType').value,sf=$('filterStatus').value;filteredTokens=allTokens.filter(t=>(tf==='all'||t.token_type===tf)&&(sf==='all'||t.status===sf.replace('-','')));selectedTokens.clear();renderTokens()},
        refreshTokens=async()=>{await loadTokens();await loadStats()},
        switchModalTab=(type, tab)=>{
            const modes = ['bulk', 'single'];
            modes.forEach(m => {
                const isSelf = m === tab;
                const btn = $(`tab${type.charAt(0).toUpperCase() + type.slice(1)}${m.charAt(0).toUpperCase() + m.slice(1)}`);
                const pnl = $(`panel${type.charAt(0).toUpperCase() + type.slice(1)}${m.charAt(0).toUpperCase() + m.slice(1)}`);
                if(btn && pnl) {
                    if(isSelf) {
                        btn.classList.add('border-primary', 'text-primary');
                        btn.classList.remove('border-transparent', 'text-muted-foreground');
                        pnl.classList.remove('hidden');
                    } else {
                        btn.classList.remove('border-primary', 'text-primary');
                        btn.classList.add('border-transparent', 'text-muted-foreground');
                        pnl.classList.add('hidden');
                    }
                }
            });
        },
        openAddModal=()=>{
            $('addModal').classList.remove('hidden');
            switchModalTab('token', 'bulk');
        },
        closeAddModal=()=>{
            $('addModal').classList.add('hidden');
            $('addTokenList').value='';
            $('addTokenSingleInput').value='';
        },
        deleteToken=async(t,tt)=>{if(!confirm('Are you sure you want to delete this token?'))return;try{const r=await apiRequest('/api/tokens/delete',{method:'POST',body:JSON.stringify({tokens:[t],token_type:tt})});if(!r)return;const d=await r.json();d.success?await refreshTokens():alert('Delete failed: '+(d.error||'Unknown error'))}catch(e){alert('Delete failed: '+e.message)}},
        batchDelete=async()=>{if(!selectedTokens.size||!confirm(`Are you sure you want to delete the selected ${selectedTokens.size} tokens? This action cannot be undone!`))return;const tbt={sso:[],ssoSuper:[]};document.querySelectorAll('.token-checkbox:checked').forEach(cb=>tbt[cb.dataset.type].push(cb.dataset.token));try{const ps=[];['sso','ssoSuper'].forEach(k=>tbt[k].length&&ps.push(apiRequest('/api/tokens/delete',{method:'POST',body:JSON.stringify({tokens:tbt[k],token_type:k})})));await Promise.all(ps);await refreshTokens()}catch(e){alert('Batch delete failed: '+e.message)}},
        submitAddTokens=async()=>{
            const tt=$('addTokenType').value;
            let tks=[];
            if(!$('panelTokenBulk').classList.contains('hidden')) {
                tks = $('addTokenList').value.split('\n').map(t=>t.trim()).filter(t=>t);
            } else {
                const val = $('addTokenSingleInput').value.trim();
                if(val) tks.push(val);
            }
            if(!tks.length)return alert('Please enter at least one token');
            try{const r=await apiRequest('/api/tokens/add',{method:'POST',body:JSON.stringify({tokens:tks,token_type:tt})});if(!r)return;const d=await r.json();d.success?(closeAddModal(),await refreshTokens()):alert('Add failed: '+(d.error||'Unknown error'))}catch(e){alert('Add failed: '+e.message)}
        },
        copyToken=async(t,e)=>{e.stopPropagation();try{await navigator.clipboard.writeText(t);showToast('Token copied to clipboard','success')}catch(err){console.error('Copy failed:',err);showToast('Copy failed, please copy manually','error')}},
        refreshAllLimits=async()=>{const t=$("refresh-status");t.textContent="Refreshing...";try{const e=await apiRequest("/api/refresh-limits",{method:"POST"});if(!e)return;const s=await e.json();s.success?(showToast(s.message||"Rate limits refresh started.","success"),setTimeout(()=>{refreshTokens(),t.textContent=""},2e3)):(showToast(s.message||"Failed to start refresh.","error"),t.textContent="Error!")}catch(e){showToast("An error occurred while refreshing limits.","error"),t.textContent="Error!"}};
 
         const exportSelected=()=>{if(!selectedTokens.size)return showToast('Please select tokens to export first','error');const sd=allTokens.filter(t=>selectedTokens.has(t.token)),csv=[['Token','Type','Status','Normal Remaining','Heavy Remaining','Created Time'].join(','),...sd.map(t=>[`"${t.token}"`,t.token_type==='sso'?'SSO':'SuperSSO',t.status,t.remaining_queries===-1?'Unused':t.remaining_queries,t.heavy_remaining_queries===-1?'Unused':t.heavy_remaining_queries,`"${t.created_time?new Date(t.created_time).toLocaleString('en-US'):'-'}"`].join(','))].join('\n'),l=document.createElement('a');l.href=URL.createObjectURL(new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'}));l.download=`grok_tokens_${new Date().toISOString().slice(0,10)}.csv`;l.style.display='none';document.body.appendChild(l);l.click();document.body.removeChild(l);URL.revokeObjectURL(l.href);showToast(`Exported ${selectedTokens.size} tokens`,'success')}
        showToast=(m,t='info')=>{const d=document.createElement('div'),bc={success:'bg-green-600',error:'bg-destructive',info:'bg-primary'};d.className=`fixed bottom-4 right-4 ${bc[t]||bc.info} text-white px-4 py-2.5 rounded-lg shadow-lg text-sm font-medium z-50 animate-slide-up`;d.textContent=m;document.body.appendChild(d);setTimeout(()=>{d.style.opacity='0';d.style.transition='opacity .3s';setTimeout(()=>d.parentNode&&document.body.removeChild(d),300)},2000)}
        logout=async()=>{if(!confirm('Are you sure you want to log out?'))return;try{await apiRequest('/api/logout',{method:'POST'})}catch(e){console.error('Logout failed:',e)}finally{localStorage.removeItem('adminToken');location.href='/login'}},
        switchTab=t=>{['tokens','settings','cloudinary'].forEach(n=>{$(`panel${n.charAt(0).toUpperCase()+n.slice(1)}`).classList[n===t?'remove':'add']('hidden');$(`tab${n.charAt(0).toUpperCase()+n.slice(1)}`).classList[n===t?'add':'remove']('border-primary','text-primary');$(`tab${n.charAt(0).toUpperCase()+n.slice(1)}`).classList[n===t?'remove':'add']('border-transparent','text-muted-foreground')});if(t==='settings'){loadSettings()}else if(t==='cloudinary'){loadCloudinaryAccounts()}},
        updateCacheProxyReadonly=()=>{const proxyUrl=$('cfgProxyUrl').value.trim(),cacheProxyInput=$('cfgCacheProxyUrl');if(proxyUrl){cacheProxyInput.readOnly=false;cacheProxyInput.classList.remove('bg-muted');cacheProxyInput.placeholder='socks5://username:password@127.0.0.1:7890'}else{cacheProxyInput.readOnly=true;cacheProxyInput.classList.add('bg-muted');cacheProxyInput.value='';cacheProxyInput.placeholder='Set service proxy to enable'}};
        loadSettings=async()=>{try{const r=await apiRequest('/api/settings');if(!r)return;const d=await r.json();if(d.success){const g=d.data.global,k=d.data.grok;$('cfgAdminUser').value=g.admin_username||'';$('cfgAdminPass').value='';$('cfgLogLevel').value=g.log_level||'DEBUG';$('cfgImageCacheMaxSize').value=g.image_cache_max_size_mb||500;$('cfgVideoCacheMaxSize').value=g.video_cache_max_size_mb||1000;$('cfgImageMode').value=g.image_mode||'url';$('cfgBaseUrl').value=g.base_url||'';$('cfgApiKey').value=k.api_key||'';$('cfgProxyUrl').value=k.proxy_url||'';$('cfgCacheProxyUrl').value=k.cache_proxy_url||'';$('cfgCfClearance').value=k.cf_clearance||'';$('cfgStatsigId').value=k.x_statsig_id||'';$('cfgFilteredTags').value=k.filtered_tags||'';$('cfgTemporary').value=k.temporary!==false?'true':'false';$('cfgStreamChunkTimeout').value=k.stream_chunk_timeout||120;$('cfgStreamFirstResponseTimeout').value=k.stream_first_response_timeout||30;$('cfgStreamTotalTimeout').value=k.stream_total_timeout||600;updateCacheProxyReadonly();await loadCacheSize()}}catch(e){console.error('Failed to load settings:',e);showToast('Failed to load settings','error')}},
        loadCloudinaryAccounts=async()=>{try{const r=await apiRequest('/api/cloudinary/accounts');if(!r)return;const d=await r.json();if(d.success){renderCloudinaryAccounts(d.data)}}catch(e){console.error('Failed to load Cloudinary accounts:',e)}},
        renderCloudinaryAccounts=(accounts)=>{const tb=$('cloudinaryTableBody'),es=$('cloudinaryEmptyState');if(!accounts.length){tb.innerHTML='';es.classList.remove('hidden');return}es.classList.add('hidden');tb.innerHTML=accounts.map(acc=>`<tr><td class="p-3">${acc.cloud_name}</td><td class="p-3">${acc.api_key}</td><td class="p-3 text-right"><button onclick="deleteCloudinaryAccount('${acc.api_key}')" class="inline-flex items-center justify-center rounded-md text-xs font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring hover:bg-destructive/10 hover:text-destructive h-7 w-7"><svg class="h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button></td></tr>`).join('')},
        openAddCloudinaryModal=()=>{
            $('addCloudinaryModal').classList.remove('hidden');
            switchModalTab('cloudinary', 'bulk');
        },
        closeAddCloudinaryModal=()=>{
            $('addCloudinaryAccountList').value='';
            $('addCloudinaryName').value='';
            $('addCloudinaryKey').value='';
            $('addCloudinarySecret').value='';
            $('addCloudinaryModal').classList.add('hidden');
        },
        submitAddCloudinaryAccount=async()=>{
            let urls = [];
            if(!$('panelCloudinaryBulk').classList.contains('hidden')) {
                urls=$('addCloudinaryAccountList').value.split('\n').map(u=>u.trim()).filter(u=>u);
            } else {
                const name = $('addCloudinaryName').value.trim();
                const key = $('addCloudinaryKey').value.trim();
                const secret = $('addCloudinarySecret').value.trim();
                if(name && key && secret) {
                    urls.push(`cloudinary://${key}:${secret}@${name}`);
                } else if (name || key || secret) {
                    return alert('Please fill in all fields');
                }
            }
            if(!urls.length)return alert('Please enter at least one Cloudinary account');
            try{const r=await apiRequest('/api/cloudinary/accounts/add',{method:'POST',body:JSON.stringify({urls:urls})});if(!r)return;const d=await r.json();d.success?(closeAddCloudinaryModal(),loadCloudinaryAccounts()):alert('Add failed: '+(d.error||'Unknown error'))}catch(e){alert('Add failed: '+e.message)}},
        deleteCloudinaryAccount=async(apiKey)=>{if(!confirm('Are you sure you want to delete this Cloudinary account?'))return;try{const r=await apiRequest('/api/cloudinary/accounts/delete',{method:'POST',body:JSON.stringify({api_keys:[apiKey]})});if(!r)return;const d=await r.json();d.success?loadCloudinaryAccounts():alert('Delete failed: '+(d.error||'Unknown error'))}catch(e){alert('Delete failed: '+e.message)}},
        loadCacheSize=async()=>{try{const r=await apiRequest('/api/cache/size');if(!r)return;const d=await r.json();if(d.success){$('imageCacheSize').value=d.data.image_size||'0 MB';$('videoCacheSize').value=d.data.video_size||'0 MB';$('totalCacheSize').value=d.data.total_size||'0 MB'}}catch(e){console.error('Failed to load cache size:',e);$('imageCacheSize').value='0 MB';$('videoCacheSize').value='0 MB';$('totalCacheSize').value='0 MB'}},
        clearImageCache=async()=>{if(!confirm('Are you sure you want to clear the image cache? This will delete all cached image files!'))return;try{const r=await apiRequest('/api/cache/clear/images',{method:'POST'});if(!r)return;const d=await r.json();d.success?(showToast(`Image cache cleared, ${d.data.deleted_count||0} files deleted`,'success'),await loadCacheSize()):showToast('Clear failed: '+(d.error||'Unknown error'),'error')}catch(e){showToast('Clear failed: '+e.message,'error')}},
        clearVideoCache=async()=>{if(!confirm('Are you sure you want to clear the video cache? This will delete all cached video files!'))return;try{const r=await apiRequest('/api/cache/clear/videos',{method:'POST'});if(!r)return;const d=await r.json();d.success?(showToast(`Video cache cleared, ${d.data.deleted_count||0} files deleted`,'success'),await loadCacheSize()):showToast('Clear failed: '+(d.error||'Unknown error'),'error')}catch(e){showToast('Clear failed: '+e.message,'error')}},
        clearCache=async()=>{if(!confirm('Are you sure you want to clear the cache? This will delete all files in the /data/temp directory!'))return;try{const r=await apiRequest('/api/cache/clear',{method:'POST'});if(!r)return;const d=await r.json();d.success?(showToast(`Cache cleared, ${d.data.deleted_count||0} files deleted`,'success'),await loadCacheSize()):showToast('Clear failed: '+(d.error||'Unknown error'),'error')}catch(e){showToast('Clear failed: '+e.message,'error')}},
        saveGlobalSettings=async()=>{const gc={admin_username:$('cfgAdminUser').value,log_level:$('cfgLogLevel').value,image_cache_max_size_mb:parseInt($('cfgImageCacheMaxSize').value)||500,video_cache_max_size_mb:parseInt($('cfgVideoCacheMaxSize').value)||1000,image_mode:$('cfgImageMode').value,base_url:$('cfgBaseUrl').value};if($('cfgAdminPass').value)gc.admin_password=$('cfgAdminPass').value;try{const r=await apiRequest('/api/settings');if(!r)return;const d=await r.json();if(!d.success)return showToast('Failed to load settings','error');const s=await apiRequest('/api/settings',{method:'POST',body:JSON.stringify({global_config:gc,grok_config:d.data.grok})});if(!s)return;const sd=await s.json();sd.success?(showToast('Global settings saved successfully','success'),$('cfgAdminPass').value=''):showToast('Save failed: '+(sd.error||'Unknown error'),'error')}catch(e){showToast('Save failed: '+e.message,'error')}},
        saveGrokSettings=async()=>{const pu=$('cfgProxyUrl').value.trim(),kc={api_key:$('cfgApiKey').value,proxy_url:pu,cache_proxy_url:pu?$('cfgCacheProxyUrl').value:'',cf_clearance:$('cfgCfClearance').value,x_statsig_id:$('cfgStatsigId').value,filtered_tags:$('cfgFilteredTags').value,temporary:$('cfgTemporary').value==='true',stream_chunk_timeout:parseInt($('cfgStreamChunkTimeout').value)||120,stream_first_response_timeout:parseInt($('cfgStreamFirstResponseTimeout').value)||30,stream_total_timeout:parseInt($('cfgStreamTotalTimeout').value)||600};try{const r=await apiRequest('/api/settings');if(!r)return;const d=await r.json();if(!d.success)return showToast('Failed to load settings','error');const s=await apiRequest('/api/settings',{method:'POST',body:JSON.stringify({global_config:d.data.global,grok_config:kc})});if(!s)return;const sd=await s.json();sd.success?showToast('Grok settings saved successfully','success'):showToast('Save failed: '+(sd.error||'Unknown error'),'error')}catch(e){showToast('Save failed: '+e.message,'error')}};
        const updateHoverCardPosition=(cardElement)=>{const trigger=cardElement.querySelector('.hover-card-trigger'),content=cardElement.querySelector('.hover-card-content');if(!trigger||!content)return;console.log('Updating hover card position',cardElement,trigger,content);const rect=trigger.getBoundingClientRect(),windowHeight=window.innerHeight,spaceAbove=rect.top,spaceBelow=windowHeight-rect.bottom;content.classList.remove('top','bottom');const originalVisibility=getComputedStyle(content).visibility,originalOpacity=getComputedStyle(content).opacity;content.style.visibility='hidden';content.style.opacity='1';const contentHeight=content.offsetHeight;content.style.visibility=originalVisibility;content.style.opacity=originalOpacity;const position=spaceAbove>contentHeight+10?'top':spaceBelow>contentHeight+10?'bottom':'top';content.classList.add(position);console.log('Hover card position:',position,'Height:',contentHeight,'Space above:',spaceAbove,'Space below:',spaceBelow)},
        loadStorageMode=async()=>{try{const r=await apiRequest('/api/storage/mode');if(!r)return;const d=await r.json();if(d.success){const mode=d.data.mode;console.log('Storage mode:',mode);$('storageModeText').textContent=mode;if(mode==='MYSQL'){$('storageMode').classList.add('bg-blue-50','text-blue-700','border-blue-200');$('storageModeTooltip').textContent='Database Connection Mode - Data is persisted, slower to modify but safer'}else if(mode==='REDIS'){$('storageMode').classList.add('bg-purple-50','text-purple-700','border-purple-200');$('storageModeTooltip').textContent='Redis Cache Mode - High-speed in-memory storage, data is persisted with excellent read/write performance'}else{$('storageMode').classList.add('bg-green-50','text-green-700','border-green-200');$('storageModeTooltip').textContent='File Storage Mode - Local file storage, fast read/write speed'};updateHoverCardPosition($('storageMode').closest('.hover-card'))}}catch(e){console.error('Failed to load storage mode:',e);$('storageModeText').textContent='FILE';$('storageMode').classList.add('bg-green-50','text-green-700','border-green-200');$('storageModeTooltip').textContent='File Storage Mode - Local file storage, fast read/write speed';updateHoverCardPosition($('storageMode').closest('.hover-card'))}};
        window.addEventListener('DOMContentLoaded',()=>{checkAuth();loadStorageMode();refreshTokens();setInterval(()=>{loadStats();updateRemaining()},30000);window.addEventListener('resize',()=>{const hoverCard=$('storageMode').closest('.hover-card');hoverCard&&updateHoverCardPosition(hoverCard)});const hoverCard=$('storageMode').closest('.hover-card'),trigger=hoverCard?.querySelector('.hover-card-trigger'),content=hoverCard?.querySelector('.hover-card-content');if(trigger&&content){trigger.addEventListener('mouseenter',()=>{content.style.opacity='1';content.style.visibility='visible'});trigger.addEventListener('mouseleave',()=>{content.style.opacity='0';content.style.visibility='hidden'})};$('cfgProxyUrl').addEventListener('input',updateCacheProxyReadonly)});
    </script>
</body>
</html>