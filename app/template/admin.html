<!DOCTYPE html>
<html lang="en" class="h-full" id="htmlRoot">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console - Grok2API</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: { DEFAULT: "hsl(var(--primary))", foreground: "hsl(var(--primary-foreground))" },
                        secondary: { DEFAULT: "hsl(var(--secondary))", foreground: "hsl(var(--secondary-foreground))" },
                        destructive: { DEFAULT: "hsl(var(--destructive))", foreground: "hsl(var(--destructive-foreground))" },
                        muted: { DEFAULT: "hsl(var(--muted))", foreground: "hsl(var(--muted-foreground))" },
                        accent: { DEFAULT: "hsl(var(--accent))", foreground: "hsl(var(--accent-foreground))" },
                        card: { DEFAULT: "hsl(var(--card))", foreground: "hsl(var(--card-foreground))" },
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --background: 0 0% 100%; --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%; --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%; --popover-foreground: 222.2 84% 4.9%;
            --primary: 222.2 47.4% 11.2%; --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96.1%; --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%; --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96.1%; --accent-foreground: 222.2 47.4% 11.2%;
            --destructive: 0 84.2% 60.2%; --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%; --input: 214.3 31.8% 91.4%; --ring: 222.2 84% 4.9%;
            --radius: 0.5rem;
        }
        .dark {
            --background: 222.2 84% 4.9%; --foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%; --card-foreground: 210 40% 98%;
            --popover: 222.2 84% 4.9%; --popover-foreground: 210 40% 98%;
            --primary: 210 40% 98%; --primary-foreground: 222.2 47.4% 11.2%;
            --secondary: 217.2 32.6% 17.5%; --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%; --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%; --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%; --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%; --input: 217.2 32.6% 17.5%; --ring: 212.7 26.8% 83.9%;
        }
        @keyframes slide-in-right { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .animate-slide-in { animation: slide-in-right 0.3s ease-out forwards; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: hsl(var(--muted-foreground) / 0.3); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: hsl(var(--muted-foreground) / 0.5); }

        .glass-panel { background: hsl(var(--card) / 0.8); backdrop-filter: blur(12px); }
    </style>
</head>
<body class="h-full bg-background text-foreground antialiased font-sans overflow-hidden flex">

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 transform transition-transform duration-300 -translate-x-full lg:translate-x-0 bg-card border-r border-border flex flex-col">
        <!-- Logo -->
        <div class="h-16 flex items-center px-6 border-b border-border">
            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
            <span class="font-bold text-xl">Grok2API</span>
        </div>

        <!-- Nav Links -->
        <nav class="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center px-3 py-2.5 text-sm font-medium rounded-md group transition-colors bg-primary/10 text-primary">
                <svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                Dashboard
            </button>
            <button onclick="switchTab('tokens')" id="nav-tokens" class="nav-item w-full flex items-center px-3 py-2.5 text-sm font-medium rounded-md group transition-colors hover:bg-muted text-muted-foreground hover:text-foreground">
                <svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11.542 12.93a2 2 0 00-.497 1.93l2.718 5.51a2 2 0 01-.438 2.195l-.813.813a1.998 1.998 0 01-2.828 0l-2.828-2.828a2 2 0 010-2.828l.813-.813a2 2 0 001.817-3.27l-5.51-2.718a2 2 0 00-1.93.498L6.838 9.83a2 2 0 002.266.66 2 2 0 00.756-.27 2.002 2.002 0 012.223-2.934l-.215-.215a6 6 0 01-5.37-5.37 6 6 0 0110.74 0z"></path></svg>
                Token Management
            </button>
            <button onclick="switchTab('settings')" id="nav-settings" class="nav-item w-full flex items-center px-3 py-2.5 text-sm font-medium rounded-md group transition-colors hover:bg-muted text-muted-foreground hover:text-foreground">
                <svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                Global Settings
            </button>
            <button onclick="switchTab('cloudinary')" id="nav-cloudinary" class="nav-item w-full flex items-center px-3 py-2.5 text-sm font-medium rounded-md group transition-colors hover:bg-muted text-muted-foreground hover:text-foreground">
                <svg class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path></svg>
                Cloudinary
            </button>
        </nav>

        <!-- Footer Actions -->
        <div class="p-4 border-t border-border space-y-2">
            <div class="flex items-center justify-between px-2">
                <span class="text-xs font-medium text-muted-foreground">Theme</span>
                <button onclick="toggleTheme()" class="p-2 rounded-md hover:bg-muted transition-colors text-muted-foreground hover:text-foreground" title="Toggle Theme">
                    <svg id="themeIconSun" class="w-4 h-4 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="themeIconMoon" class="w-4 h-4 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
            <button onclick="logout()" class="w-full flex items-center px-3 py-2 text-sm font-medium text-destructive hover:bg-destructive/10 rounded-md transition-colors">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                Logout
            </button>
        </div>
    </aside>

    <!-- Mobile Overlay -->
    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden backdrop-blur-sm transition-opacity"></div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col min-w-0 lg:ml-64 transition-all duration-300">
        <!-- Mobile Header -->
        <header class="lg:hidden h-16 flex items-center justify-between px-4 border-b border-border bg-background/80 backdrop-blur sticky top-0 z-30">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="p-2 -ml-2 rounded-md hover:bg-accent text-muted-foreground">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <span class="font-bold text-lg">Grok2API</span>
            </div>
        </header>

        <main class="flex-1 p-4 lg:p-8 overflow-y-auto h-full">

            <!-- Dashboard View -->
            <div id="view-dashboard" class="space-y-6">
                <div class="flex items-center justify-between">
                    <h1 class="text-2xl font-bold tracking-tight">Dashboard</h1>
                    <div class="flex items-center gap-2">
                        <div class="px-3 py-1 rounded-full bg-muted text-xs font-medium text-muted-foreground border border-border flex items-center gap-2">
                            <span class="relative flex h-2 w-2">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                            </span>
                            <span id="storageModeText">FILE</span> Storage
                        </div>
                        <button onclick="refreshTokens()" class="p-2 rounded-md hover:bg-accent text-muted-foreground hover:text-foreground transition-colors" title="Refresh Data">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        </button>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
                    <div class="rounded-xl border border-border bg-card p-6 shadow-sm">
                        <div class="flex items-center justify-between space-y-0 pb-2">
                            <p class="text-sm font-medium text-muted-foreground">Total Tokens</p>
                            <svg class="h-4 w-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11.542 12.93a2 2 0 00-.497 1.93l2.718 5.51a2 2 0 01-.438 2.195l-.813.813a1.998 1.998 0 01-2.828 0l-2.828-2.828a2 2 0 010-2.828l.813-.813a2 2 0 001.817-3.27l-5.51-2.718a2 2 0 00-1.93.498L6.838 9.83a2 2 0 002.266.66 2 2 0 00.756-.27 2.002 2.002 0 012.223-2.934l-.215-.215a6 6 0 01-5.37-5.37 6 6 0 0110.74 0z"></path></svg>
                        </div>
                        <div class="text-2xl font-bold" id="dashTotal">-</div>
                        <div class="flex mt-3 h-1.5 w-full rounded-full bg-secondary overflow-hidden">
                            <div id="barActive" class="bg-green-500 h-full transition-all duration-500" style="width: 0%"></div>
                            <div id="barLimited" class="bg-orange-400 h-full transition-all duration-500" style="width: 0%"></div>
                            <div id="barExpired" class="bg-destructive h-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-muted-foreground mt-2">
                            <span class="text-green-600 font-medium" id="dashActive">0</span> Active ·
                            <span class="text-orange-500 font-medium" id="dashLimited">0</span> Limited ·
                            <span class="text-destructive font-medium" id="dashExpired">0</span> Expired
                        </p>
                    </div>

                    <div class="rounded-xl border border-border bg-card p-6 shadow-sm">
                        <div class="flex items-center justify-between space-y-0 pb-2">
                            <p class="text-sm font-medium text-muted-foreground">Total Quota</p>
                            <svg class="h-4 w-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </div>
                        <div class="text-2xl font-bold" id="dashTotalRemaining">-</div>
                        <p class="text-xs text-muted-foreground mt-1">Combined remaining queries</p>
                    </div>

                    <div class="rounded-xl border border-border bg-card p-6 shadow-sm">
                        <div class="flex items-center justify-between space-y-0 pb-2">
                            <p class="text-sm font-medium text-muted-foreground">Normal Quota</p>
                            <span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-blue-500 text-white shadow hover:bg-blue-500/80">Basic</span>
                        </div>
                        <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="dashNormalRemaining">-</div>
                    </div>

                    <div class="rounded-xl border border-border bg-card p-6 shadow-sm">
                        <div class="flex items-center justify-between space-y-0 pb-2">
                            <p class="text-sm font-medium text-muted-foreground">Heavy Quota</p>
                            <span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-purple-500 text-white shadow hover:bg-purple-500/80">Super</span>
                        </div>
                        <div class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="dashHeavyRemaining">-</div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid gap-4 md:grid-cols-2">
                    <div class="rounded-xl border border-border bg-card p-6 shadow-sm">
                        <h3 class="font-semibold mb-4">Quick Actions</h3>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="switchTab('tokens'); openAddModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 py-2">
                                <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                Add Tokens
                            </button>
                            <button onclick="refreshAllLimits()" class="inline-flex items-center justify-center rounded-md text-sm font-medium border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">
                                <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                Refresh Limits
                            </button>
                            <button onclick="switchTab('settings')" class="inline-flex items-center justify-center rounded-md text-sm font-medium border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">
                                <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                Config
                            </button>
                        </div>
                    </div>
                    <div class="rounded-xl border border-border bg-card p-6 shadow-sm">
                        <h3 class="font-semibold mb-4">Cache Status</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between text-sm">
                                <span class="text-muted-foreground">Images</span>
                                <span class="font-mono" id="dashImageCache">0 MB</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-muted-foreground">Videos</span>
                                <span class="font-mono" id="dashVideoCache">0 MB</span>
                            </div>
                            <div class="pt-2 border-t border-border flex justify-between items-center">
                                <span class="text-sm font-medium">Total</span>
                                <div class="flex items-center gap-2">
                                    <span class="font-mono font-bold" id="dashTotalCache">0 MB</span>
                                    <button onclick="clearCache()" class="text-xs bg-secondary hover:bg-secondary/80 px-2 py-1 rounded text-secondary-foreground transition-colors">Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Token Management View -->
            <div id="view-tokens" class="space-y-6 hidden">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                    <h1 class="text-2xl font-bold tracking-tight">Token Management</h1>
                    <div class="flex items-center gap-2 w-full sm:w-auto">
                        <div class="relative flex-1 sm:flex-initial">
                            <svg class="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            <input id="searchInput" onkeyup="filterTokens()" type="text" placeholder="Search tokens..." class="pl-9 h-9 w-full sm:w-64 rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                        </div>
                        <button onclick="openAddModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 shadow">
                            <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            Add
                        </button>
                    </div>
                </div>

                <div class="rounded-xl border border-border bg-card shadow-sm overflow-hidden">
                    <!-- Toolbar -->
                    <div class="flex flex-wrap items-center gap-4 p-4 border-b border-border bg-muted/30">
                        <div class="flex items-center gap-2">
                            <select id="filterType" onchange="filterTokens()" class="h-8 px-3 text-sm rounded-md border border-input bg-background focus:outline-none focus:ring-1 focus:ring-ring">
                                <option value="all">All Types</option>
                                <option value="sso">SSO</option>
                                <option value="ssoSuper">SuperSSO</option>
                            </select>
                            <select id="filterStatus" onchange="filterTokens()" class="h-8 px-3 text-sm rounded-md border border-input bg-background focus:outline-none focus:ring-1 focus:ring-ring">
                                <option value="all">All Status</option>
                                <option value="Active">Active</option>
                                <option value="Rate-Limited">Rate-Limited</option>
                                <option value="Expired">Expired</option>
                                <option value="Unused">Unused</option>
                            </select>
                        </div>
                        <div class="flex-1"></div>
                        <div id="batchActions" class="hidden items-center gap-2 animate-slide-in">
                            <span id="selectedCount" class="text-sm text-muted-foreground mr-2">0 selected</span>
                            <button onclick="exportSelected()" class="h-8 px-3 text-xs font-medium rounded-md border border-input bg-background hover:bg-accent">Export</button>
                            <button onclick="batchDelete()" class="h-8 px-3 text-xs font-medium rounded-md bg-destructive/10 text-destructive hover:bg-destructive/20">Delete</button>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="relative w-full overflow-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-muted/50 text-muted-foreground font-medium">
                                <tr>
                                    <th class="h-10 px-4 align-middle w-10">
                                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="h-4 w-4 rounded border-input text-primary focus:ring-ring">
                                    </th>
                                    <th class="h-10 px-4 align-middle">Token</th>
                                    <th class="h-10 px-4 align-middle w-24">Type</th>
                                    <th class="h-10 px-4 align-middle w-24">Status</th>
                                    <th class="h-10 px-4 align-middle w-24">Normal</th>
                                    <th class="h-10 px-4 align-middle w-24">Heavy</th>
                                    <th class="h-10 px-4 align-middle w-40">Created</th>
                                    <th class="h-10 px-4 align-middle w-16 text-right"></th>
                                </tr>
                            </thead>
                            <tbody id="tokenTableBody" class="divide-y divide-border">
                                <!-- Content injected via JS -->
                            </tbody>
                        </table>
                    </div>
                    <div id="emptyState" class="hidden flex flex-col items-center justify-center py-12 text-center">
                        <div class="rounded-full bg-muted p-3 mb-3">
                            <svg class="h-6 w-6 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg>
                        </div>
                        <h3 class="text-lg font-semibold">No tokens found</h3>
                        <p class="text-sm text-muted-foreground mt-1">Adjust filters or add new tokens to get started.</p>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="view-settings" class="space-y-6 hidden">
                <div class="flex items-center justify-between">
                    <h1 class="text-2xl font-bold tracking-tight">Global Settings</h1>
                    <div class="flex gap-2">
                        <button onclick="saveGlobalSettings(); saveGrokSettings();" class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 shadow">
                            Save All Changes
                        </button>
                    </div>
                </div>

                <div class="grid gap-6 lg:grid-cols-2">
                    <!-- System -->
                    <div class="space-y-6">
                        <div class="rounded-xl border border-border bg-card p-6 shadow-sm">
                            <h3 class="font-semibold mb-4 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                System
                            </h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium">Admin User</label>
                                        <input id="cfgAdminUser" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" placeholder="admin">
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium">Admin Password</label>
                                        <input id="cfgAdminPass" type="password" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" placeholder="Keep unchanged">
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-sm font-medium">Log Level</label>
                                    <select id="cfgLogLevel" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                                        <option>DEBUG</option><option>INFO</option><option>WARNING</option><option>ERROR</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="rounded-xl border border-border bg-card p-6 shadow-sm">
                            <h3 class="font-semibold mb-4 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path></svg>
                                Network & Proxy
                            </h3>
                            <div class="space-y-4">
                                <div class="space-y-2">
                                    <label class="text-sm font-medium">Service Proxy (API)</label>
                                    <input id="cfgProxyUrl" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" placeholder="socks5://user:pass@host:port">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-sm font-medium">Cache Proxy (Media)</label>
                                    <input id="cfgCacheProxyUrl" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" placeholder="Same as Service Proxy if empty">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-sm font-medium">CF Clearance</label>
                                    <input id="cfgCfClearance" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" placeholder="Cloudflare cookie value">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Grok & Media -->
                    <div class="space-y-6">
                        <div class="rounded-xl border border-border bg-card p-6 shadow-sm">
                            <h3 class="font-semibold mb-4 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                Grok Parameters
                            </h3>
                            <div class="space-y-4">
                                <div class="space-y-2">
                                    <label class="text-sm font-medium">API Key (Authentication)</label>
                                    <input id="cfgApiKey" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" placeholder="Optional security key">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-sm font-medium">X Statsig ID</label>
                                    <input id="cfgStatsigId" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" placeholder="Anti-bot ID">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium">Temporary Chat</label>
                                        <select id="cfgTemporary" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                                            <option value="true">Enabled</option>
                                            <option value="false">Disabled</option>
                                        </select>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium">Filter Tags</label>
                                        <input id="cfgFilteredTags" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" placeholder="tag1,tag2">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="rounded-xl border border-border bg-card p-6 shadow-sm">
                            <h3 class="font-semibold mb-4 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                Media & Timeouts
                            </h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium">Image Mode</label>
                                        <select id="cfgImageMode" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                                            <option value="url">URL</option>
                                            <option value="base64">Base64</option>
                                        </select>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium">Base URL</label>
                                        <input id="cfgBaseUrl" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" placeholder="https://your-domain.com">
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Chunk Timeout</label>
                                        <input id="cfgStreamChunkTimeout" type="number" class="flex h-8 w-full rounded-md border border-input bg-transparent px-2 py-1 text-xs shadow-sm">
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">First Resp Timeout</label>
                                        <input id="cfgStreamFirstResponseTimeout" type="number" class="flex h-8 w-full rounded-md border border-input bg-transparent px-2 py-1 text-xs shadow-sm">
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-xs font-medium">Total Timeout</label>
                                        <input id="cfgStreamTotalTimeout" type="number" class="flex h-8 w-full rounded-md border border-input bg-transparent px-2 py-1 text-xs shadow-sm">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 pt-2">
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium">Img Cache (MB)</label>
                                        <input id="cfgImageCacheMaxSize" type="number" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm">
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium">Vid Cache (MB)</label>
                                        <input id="cfgVideoCacheMaxSize" type="number" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cloudinary View -->
            <div id="view-cloudinary" class="space-y-6 hidden">
                <div class="flex items-center justify-between">
                    <h1 class="text-2xl font-bold tracking-tight">Cloudinary</h1>
                    <button onclick="openAddCloudinaryModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 shadow">
                        Add Account
                    </button>
                </div>

                <div class="rounded-xl border border-border bg-card shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-muted/50 text-muted-foreground font-medium">
                            <tr>
                                <th class="h-10 px-4 align-middle">Cloud Name</th>
                                <th class="h-10 px-4 align-middle">API Key</th>
                                <th class="h-10 px-4 align-middle text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="cloudinaryTableBody" class="divide-y divide-border">
                            <!-- Content -->
                        </tbody>
                    </table>
                    <div id="cloudinaryEmptyState" class="hidden flex flex-col items-center justify-center py-12 text-center">
                        <p class="text-sm text-muted-foreground">No Cloudinary accounts found.</p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <!-- Modals -->
    <!-- Add Token Modal -->
    <div id="addModal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4 transition-opacity opacity-0" onclick="if(event.target===this)closeAddModal()">
        <div class="bg-card text-card-foreground rounded-lg border border-border shadow-lg w-full max-w-lg transform scale-95 transition-transform duration-200" id="addModalContent">
            <div class="flex flex-col p-6 space-y-1">
                <h3 class="font-semibold tracking-tight text-lg">Add Tokens</h3>
                <p class="text-sm text-muted-foreground">Paste your Grok SSO tokens below.</p>
            </div>
            <div class="p-6 pt-0 space-y-4">
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none">Type</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="cursor-pointer border border-input rounded-md p-2 flex items-center justify-center gap-2 hover:bg-accent has-[:checked]:bg-primary/10 has-[:checked]:border-primary has-[:checked]:text-primary transition-all">
                            <input type="radio" name="tokenType" value="sso" class="sr-only" checked onchange="$('addTokenType').value='sso'">
                            <span class="font-medium text-sm">Standard SSO</span>
                        </label>
                        <label class="cursor-pointer border border-input rounded-md p-2 flex items-center justify-center gap-2 hover:bg-accent has-[:checked]:bg-primary/10 has-[:checked]:border-primary has-[:checked]:text-primary transition-all">
                            <input type="radio" name="tokenType" value="ssoSuper" class="sr-only" onchange="$('addTokenType').value='ssoSuper'">
                            <span class="font-medium text-sm">Super SSO</span>
                        </label>
                        <input type="hidden" id="addTokenType" value="sso">
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none">Tokens</label>
                    <textarea id="addTokenList" class="flex min-h-[150px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 font-mono" placeholder="sso-..., one per line"></textarea>
                </div>
            </div>
            <div class="flex items-center p-6 pt-0 justify-end gap-2">
                <button onclick="closeAddModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
                <button onclick="submitAddTokens()" class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 py-2">Add Tokens</button>
            </div>
        </div>
    </div>

    <!-- Add Cloudinary Modal -->
    <div id="addCloudinaryModal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4 transition-opacity opacity-0" onclick="if(event.target===this)closeAddCloudinaryModal()">
        <div class="bg-card text-card-foreground rounded-lg border border-border shadow-lg w-full max-w-lg transform scale-95 transition-transform duration-200">
            <div class="flex flex-col p-6 space-y-1">
                <h3 class="font-semibold tracking-tight text-lg">Add Cloudinary</h3>
            </div>
            <div class="p-6 pt-0 space-y-4">
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none">Account URL</label>
                    <textarea id="addCloudinaryAccountList" class="flex min-h-[100px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring font-mono" placeholder="cloudinary://key:secret@name"></textarea>
                </div>
            </div>
            <div class="flex items-center p-6 pt-0 justify-end gap-2">
                <button onclick="closeAddCloudinaryModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2">Cancel</button>
                <button onclick="submitAddCloudinaryAccount()" class="inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 py-2">Add</button>
            </div>
        </div>
    </div>

    <script>
        // Core Logic
        const $ = id => document.getElementById(id);
        let allTokens = [], filteredTokens = [], selectedTokens = new Set();
        let currentView = 'dashboard';

        // Auth & Initialization
        const checkAuth = () => { if (!localStorage.getItem('adminToken')) location.href = '/login'; };
        const apiRequest = async (url, opts = {}) => {
            const t = localStorage.getItem('adminToken');
            if (!t) return null;
            try {
                const r = await fetch(url, { ...opts, headers: { ...opts.headers, Authorization: `Bearer ${t}`, 'Content-Type': 'application/json' } });
                if (r.status === 401) { localStorage.removeItem('adminToken'); location.href = '/login'; return null; }
                return r;
            } catch (e) { showToast('Network error', 'error'); throw e; }
        };

        // Theme Logic
        const initTheme = () => {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        };
        const toggleTheme = () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.theme = isDark ? 'dark' : 'light';
        };

        // Navigation
        const switchTab = (view) => {
            currentView = view;
            // Update Sidebar State
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-primary/10', 'text-primary');
                el.classList.add('text-muted-foreground', 'hover:bg-muted');
            });
            const activeNav = $(`nav-${view}`);
            if (activeNav) {
                activeNav.classList.remove('text-muted-foreground', 'hover:bg-muted');
                activeNav.classList.add('bg-primary/10', 'text-primary');
            }

            // Update Content
            ['dashboard', 'tokens', 'settings', 'cloudinary'].forEach(v => {
                $(`view-${v}`).classList.toggle('hidden', v !== view);
            });

            // Refresh data based on view
            if (view === 'dashboard') loadStats();
            if (view === 'tokens') loadTokens();
            if (view === 'settings') loadSettings();
            if (view === 'cloudinary') loadCloudinaryAccounts();

            // Close sidebar on mobile
            if (window.innerWidth < 1024) {
                $('sidebar').classList.add('-translate-x-full');
                $('sidebarOverlay').classList.add('hidden');
            }
        };

        const toggleSidebar = () => {
            const sb = $('sidebar');
            const ov = $('sidebarOverlay');
            const isClosed = sb.classList.contains('-translate-x-full');
            sb.classList.toggle('-translate-x-full', !isClosed);
            ov.classList.toggle('hidden', !isClosed);
        };

        // Toast System
        const showToast = (msg, type = 'success') => {
            const c = $('toast-container');
            const id = Date.now();
            const colorClass = type === 'error' ? 'bg-destructive text-destructive-foreground' : 'bg-primary text-primary-foreground';
            const el = document.createElement('div');
            el.className = `pointer-events-auto flex items-center justify-between gap-4 rounded-md shadow-lg p-4 text-sm font-medium transition-all duration-300 transform translate-y-10 opacity-0 ${colorClass}`;
            el.innerHTML = `<span>${msg}</span><button onclick="this.parentElement.remove()" class="opacity-70 hover:opacity-100">✕</button>`;
            c.appendChild(el);

            requestAnimationFrame(() => { el.classList.remove('translate-y-10', 'opacity-0'); });
            setTimeout(() => {
                el.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        };

        // Dashboard Logic
        const loadStats = async () => {
            try {
                const r = await apiRequest('/api/stats');
                if (!r) return;
                const d = await r.json();
                if (d.success) {
                    const s = d.data;
                    const normal = s.normal || {};
                    const superT = s.super || {};

                    const total = s.total || 0;
                    const active = (normal.active || 0) + (superT.active || 0);
                    const limited = (normal.limited || 0) + (superT.limited || 0);
                    const expired = (normal.expired || 0) + (superT.expired || 0);

                    $('dashTotal').textContent = total;
                    $('dashActive').textContent = active;
                    $('dashLimited').textContent = limited;
                    $('dashExpired').textContent = expired;

                    // Update progress bars
                    if (total > 0) {
                        $('barActive').style.width = `${(active/total)*100}%`;
                        $('barLimited').style.width = `${(limited/total)*100}%`;
                        $('barExpired').style.width = `${(expired/total)*100}%`;
                    } else {
                        $('barActive').style.width = '0%';
                        $('barLimited').style.width = '0%';
                        $('barExpired').style.width = '0%';
                    }

                    // Load remaining quotas (need token list for this or separate API)
                    // Re-using calculation from tokens logic if available, else rely on what we have
                    if (allTokens.length === 0) await loadTokens(false); // Silent load
                    updateRemainingWidgets();
                }
                await loadCacheSize();
            } catch (e) { console.error(e); }
        };

        const updateRemainingWidgets = () => {
            let n = 0, h = 0;
            allTokens.forEach(t => {
                if (t.remaining_queries > 0) n += t.remaining_queries;
                if (t.heavy_remaining_queries > 0) h += t.heavy_remaining_queries;
            });
            $('dashTotalRemaining').textContent = (n + h).toLocaleString();
            $('dashNormalRemaining').textContent = n.toLocaleString();
            $('dashHeavyRemaining').textContent = h.toLocaleString();
        };

        // Token Management Logic
        const loadTokens = async (render = true) => {
            try {
                const r = await apiRequest('/api/tokens');
                if (!r) return;
                const d = await r.json();
                if (d.success) {
                    allTokens = d.data;
                    filteredTokens = allTokens; // Reset filter on reload? Or keep? keeping simple for now
                    if (render) {
                        filterTokens(); // Re-apply filters
                    }
                }
            } catch (e) { showToast('Failed to load tokens', 'error'); }
        };

        const renderTokens = () => {
            const tb = $('tokenTableBody');
            const es = $('emptyState');

            if (filteredTokens.length === 0) {
                tb.innerHTML = '';
                es.classList.remove('hidden');
                return;
            }
            es.classList.add('hidden');

            const statusColors = {
                'Unused': 'bg-muted text-muted-foreground',
                'Rate-Limited': 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400',
                'Expired': 'bg-destructive/10 text-destructive',
                'Active': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'
            };

            tb.innerHTML = filteredTokens.map(t => `
                <tr class="border-b border-border hover:bg-muted/50 transition-colors group">
                    <td class="p-4">
                        <input type="checkbox" class="h-4 w-4 rounded border-input text-primary focus:ring-ring token-checkbox"
                            data-token="${t.token}" data-type="${t.token_type}"
                            ${selectedTokens.has(t.token) ? 'checked' : ''}
                            onchange="toggleToken('${t.token}')">
                    </td>
                    <td class="p-4 font-mono text-xs text-muted-foreground max-w-[200px] truncate" title="${t.token}">
                        <div class="flex items-center gap-2">
                            <span class="truncate">${t.token.substring(0, 24)}...</span>
                            <button onclick="copyToken('${t.token.replace(/'/g,"\\'")}')" class="opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-accent rounded">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            </button>
                        </div>
                    </td>
                    <td class="p-4">
                        <span class="inline-flex items-center rounded-md border px-2 py-0.5 text-xs font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent ${t.token_type==='ssoSuper'?'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400':'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400'}">
                            ${t.token_type === 'ssoSuper' ? 'Super' : 'Basic'}
                        </span>
                    </td>
                    <td class="p-4">
                        <span class="inline-flex items-center rounded-md border px-2 py-0.5 text-xs font-medium transition-colors border-transparent ${statusColors[t.status] || 'bg-muted'}">
                            ${t.status}
                        </span>
                    </td>
                    <td class="p-4 font-mono text-xs">${t.remaining_queries === -1 ? '-' : t.remaining_queries}</td>
                    <td class="p-4 font-mono text-xs">${t.heavy_remaining_queries === -1 ? '-' : t.heavy_remaining_queries}</td>
                    <td class="p-4 text-xs text-muted-foreground">${t.created_time ? new Date(t.created_time).toLocaleDateString() : '-'}</td>
                    <td class="p-4 text-right">
                        <button onclick="deleteToken('${t.token}', '${t.token_type}')" class="p-2 hover:bg-destructive/10 text-destructive rounded transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                </tr>
            `).join('');

            updateBatchActions();
        };

        const filterTokens = () => {
            const query = $('searchInput').value.toLowerCase();
            const type = $('filterType').value;
            const status = $('filterStatus').value;

            filteredTokens = allTokens.filter(t => {
                const matchQuery = t.token.toLowerCase().includes(query);
                const matchType = type === 'all' || t.token_type === type;
                const matchStatus = status === 'all' || t.status === status.replace('-', ''); // Backend uses "RateLimited" vs UI "Rate-Limited"
                return matchQuery && matchType && matchStatus;
            });

            // Reset selection if filtered out? For now clear all to be safe
            selectedTokens.clear();
            $('selectAll').checked = false;

            renderTokens();
        };

        // Selection Logic
        const toggleToken = (t) => {
            selectedTokens.has(t) ? selectedTokens.delete(t) : selectedTokens.add(t);
            updateBatchActions();
        };
        const toggleSelectAll = () => {
            const all = $('selectAll').checked;
            filteredTokens.forEach(t => all ? selectedTokens.add(t.token) : selectedTokens.delete(t.token));
            document.querySelectorAll('.token-checkbox').forEach(c => c.checked = all);
            updateBatchActions();
        };
        const updateBatchActions = () => {
            const count = selectedTokens.size;
            $('selectedCount').textContent = `${count} selected`;
            const ba = $('batchActions');
            if (count > 0) {
                ba.classList.remove('hidden');
                ba.classList.add('flex');
            } else {
                ba.classList.add('hidden');
                ba.classList.remove('flex');
            }
        };

        // Modals
        const openAddModal = () => {
            const m = $('addModal');
            m.classList.remove('hidden');
            setTimeout(() => {
                m.classList.remove('opacity-0');
                $('addModalContent').classList.remove('scale-95');
                $('addModalContent').classList.add('scale-100');
            }, 10);
        };
        const closeAddModal = () => {
            const m = $('addModal');
            m.classList.add('opacity-0');
            $('addModalContent').classList.add('scale-95');
            $('addModalContent').classList.remove('scale-100');
            setTimeout(() => {
                m.classList.add('hidden');
                $('addTokenList').value = '';
            }, 200);
        };

        const openAddCloudinaryModal = () => {
            const m = $('addCloudinaryModal');
            m.classList.remove('hidden');
            setTimeout(() => m.classList.remove('opacity-0'), 10);
        };
        const closeAddCloudinaryModal = () => {
            const m = $('addCloudinaryModal');
            m.classList.add('opacity-0');
            setTimeout(() => {
                m.classList.add('hidden');
                $('addCloudinaryAccountList').value = '';
            }, 200);
        };

        // Actions
        const submitAddTokens = async () => {
            const type = $('addTokenType').value;
            const tokens = $('addTokenList').value.split('\n').map(t => t.trim()).filter(t => t);
            if (!tokens.length) return showToast('Please enter tokens', 'error');

            const r = await apiRequest('/api/tokens/add', { method: 'POST', body: JSON.stringify({ tokens, token_type: type }) });
            const d = await r.json();

            if (d.success) {
                showToast(`Added ${d.count} tokens`);
                closeAddModal();
                refreshTokens();
            } else {
                showToast(d.error || 'Failed to add tokens', 'error');
            }
        };

        const deleteToken = async (token, type) => {
            if (!confirm('Delete this token?')) return;
            const r = await apiRequest('/api/tokens/delete', { method: 'POST', body: JSON.stringify({ tokens: [token], token_type: type }) });
            const d = await r.json();
            if (d.success) { showToast('Token deleted'); refreshTokens(); }
            else showToast(d.error, 'error');
        };

        const batchDelete = async () => {
            if (!confirm(`Delete ${selectedTokens.size} tokens?`)) return;
            const toDelete = { sso: [], ssoSuper: [] };
            // Need to map selected tokens to their types. Inefficient but works for small lists.
            allTokens.filter(t => selectedTokens.has(t.token)).forEach(t => toDelete[t.token_type].push(t.token));

            try {
                await Promise.all([
                    toDelete.sso.length && apiRequest('/api/tokens/delete', { method: 'POST', body: JSON.stringify({ tokens: toDelete.sso, token_type: 'sso' }) }),
                    toDelete.ssoSuper.length && apiRequest('/api/tokens/delete', { method: 'POST', body: JSON.stringify({ tokens: toDelete.ssoSuper, token_type: 'ssoSuper' }) })
                ]);
                showToast('Batch delete successful');
                selectedTokens.clear();
                refreshTokens();
            } catch (e) { showToast('Partial or full failure during batch delete', 'error'); }
        };

        const copyToken = (t) => {
            navigator.clipboard.writeText(t);
            showToast('Token copied to clipboard');
        };

        const refreshAllLimits = async () => {
            showToast('Refreshing limits...', 'info');
            const r = await apiRequest('/api/refresh-limits', { method: 'POST' });
            const d = await r.json();
            d.success ? showToast('Limits refreshed') : showToast(d.message, 'error');
            refreshTokens();
        };

        // Settings & Cloudinary (Simplified for brevity, logic mirrors tokens)
        const loadSettings = async () => {
            const r = await apiRequest('/api/settings');
            if(r) {
                const d = await r.json();
                if(d.success) {
                    const g = d.data.global, k = d.data.grok;
                    $('cfgAdminUser').value = g.admin_username || '';
                    $('cfgLogLevel').value = g.log_level || 'INFO';
                    $('cfgImageMode').value = g.image_mode || 'url';
                    $('cfgBaseUrl').value = g.base_url || '';
                    $('cfgImageCacheMaxSize').value = g.image_cache_max_size_mb || 500;
                    $('cfgVideoCacheMaxSize').value = g.video_cache_max_size_mb || 1000;

                    $('cfgApiKey').value = k.api_key || '';
                    $('cfgStatsigId').value = k.x_statsig_id || '';
                    $('cfgProxyUrl').value = k.proxy_url || '';
                    $('cfgCacheProxyUrl').value = k.cache_proxy_url || '';
                    $('cfgCfClearance').value = k.cf_clearance || '';
                    $('cfgTemporary').value = k.temporary ? 'true' : 'false';
                    $('cfgFilteredTags').value = k.filtered_tags || '';
                    $('cfgStreamChunkTimeout').value = k.stream_chunk_timeout || 120;
                    $('cfgStreamFirstResponseTimeout').value = k.stream_first_response_timeout || 30;
                    $('cfgStreamTotalTimeout').value = k.stream_total_timeout || 600;
                }
            }
        };

        const saveGlobalSettings = async () => {
            // Construct payloads similar to original code
            const gc = {
                admin_username: $('cfgAdminUser').value,
                log_level: $('cfgLogLevel').value,
                image_mode: $('cfgImageMode').value,
                base_url: $('cfgBaseUrl').value,
                image_cache_max_size_mb: parseInt($('cfgImageCacheMaxSize').value),
                video_cache_max_size_mb: parseInt($('cfgVideoCacheMaxSize').value)
            };
            if ($('cfgAdminPass').value) gc.admin_password = $('cfgAdminPass').value;

            const r = await apiRequest('/api/settings', { method: 'POST', body: JSON.stringify({ global_config: gc }) });
            if (r) showToast('Global settings saved');
        };

        const saveGrokSettings = async () => {
            const kc = {
                api_key: $('cfgApiKey').value,
                x_statsig_id: $('cfgStatsigId').value,
                proxy_url: $('cfgProxyUrl').value,
                cache_proxy_url: $('cfgCacheProxyUrl').value,
                cf_clearance: $('cfgCfClearance').value,
                temporary: $('cfgTemporary').value === 'true',
                filtered_tags: $('cfgFilteredTags').value,
                stream_chunk_timeout: parseInt($('cfgStreamChunkTimeout').value),
                stream_first_response_timeout: parseInt($('cfgStreamFirstResponseTimeout').value),
                stream_total_timeout: parseInt($('cfgStreamTotalTimeout').value)
            };
            const r = await apiRequest('/api/settings', { method: 'POST', body: JSON.stringify({ grok_config: kc }) });
            if (r) showToast('Grok settings saved');
        };

        const loadCacheSize = async () => {
            const r = await apiRequest('/api/cache/size');
            if(r) {
                const d = await r.json();
                if(d.success) {
                    $('dashImageCache').textContent = d.data.image_size;
                    $('dashVideoCache').textContent = d.data.video_size;
                    $('dashTotalCache').textContent = d.data.total_size;
                }
            }
        };

        const clearCache = async () => {
            if(!confirm('Clear all cache?')) return;
            const r = await apiRequest('/api/cache/clear', { method: 'POST' });
            if(r) { showToast('Cache cleared'); loadCacheSize(); }
        };

        const loadCloudinaryAccounts = async () => {
            const r = await apiRequest('/api/cloudinary/accounts');
            if(r) {
                const d = await r.json();
                if(d.success) {
                    const tb = $('cloudinaryTableBody');
                    if(!d.data.length) { tb.innerHTML=''; $('cloudinaryEmptyState').classList.remove('hidden'); return; }
                    $('cloudinaryEmptyState').classList.add('hidden');
                    tb.innerHTML = d.data.map(a => `
                        <tr class="border-b border-border hover:bg-muted/50">
                            <td class="p-4">${a.cloud_name}</td>
                            <td class="p-4 font-mono text-xs">${a.api_key}</td>
                            <td class="p-4 text-right">
                                <button onclick="deleteCloudinary('${a.api_key}')" class="text-destructive hover:underline">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                }
            }
        };

        const submitAddCloudinaryAccount = async () => {
            const urls = $('addCloudinaryAccountList').value.split('\n').filter(u=>u.trim());
            const r = await apiRequest('/api/cloudinary/accounts/add', { method: 'POST', body: JSON.stringify({ urls }) });
            if(r && (await r.json()).success) { showToast('Added Cloudinary accounts'); closeAddCloudinaryModal(); loadCloudinaryAccounts(); }
            else showToast('Failed to add', 'error');
        };

        const deleteCloudinary = async (key) => {
            if(!confirm('Delete account?')) return;
            const r = await apiRequest('/api/cloudinary/accounts/delete', { method: 'POST', body: JSON.stringify({ api_keys: [key] }) });
            if(r && (await r.json()).success) loadCloudinaryAccounts();
        };

        const loadStorageMode = async()=>{
            try{
                const r=await apiRequest('/api/storage/mode');
                if(!r)return;
                const d=await r.json();
                if(d.success) $('storageModeText').textContent=d.data.mode;
            }catch(e){}
        };

        // Init
        window.addEventListener('DOMContentLoaded', () => {
            initTheme();
            checkAuth();
            loadStorageMode();
            switchTab('dashboard'); // Load initial view

            // Auto refresh stats
            setInterval(() => {
                if(currentView === 'dashboard') loadStats();
            }, 30000);
        });
    </script>
</body>
</html>
